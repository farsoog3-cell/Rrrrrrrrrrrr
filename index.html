<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>go2</title>
<style>
body, html { margin:0; padding:0; height:100%; width:100%; font-family:'Segoe UI',sans-serif; display:flex; flex-direction:column; background:#f9f6ff;}
header { background: linear-gradient(90deg,#7e57c2,#512da8); color:#fff; text-align:center; padding:15px 0; font-size:1.4em; font-weight:bold; box-shadow:0 2px 6px rgba(0,0,0,0.1);}
#main { flex:1 1 auto; display:flex; justify-content:center; align-items:center; padding:20px;}
canvas { display:block; background:#ffffff; border-radius:20px; box-shadow:0 4px 10px rgba(126,87,194,0.2); border:2px solid #d1c4e9;}
#board { width:80vmin; height:80vmin;}
.controls { flex:0 0 auto; padding:10px; background:#ffffff; display:flex; justify-content:center; align-items:center; border-top:2px solid #e1bee7; flex-wrap:wrap;}
button { padding:8px 12px; margin:5px; border-radius:12px; border:none; cursor:pointer; transition:0.3s; background:#7e57c2; color:#fff; font-weight:600; box-shadow:0 2px 4px rgba(126,87,194,0.3);}
button:hover { background:#512da8; box-shadow:0 3px 6px rgba(81,45,168,0.4);}
.upload-btn-wrapper { position: relative; overflow: hidden; display: inline-block;}
.upload-btn { background:#7e57c2; color:white; font-weight:600; padding:8px 20px; border-radius:12px; cursor:pointer; box-shadow:0 2px 4px rgba(126,87,194,0.3);}
.upload-btn:hover { background:#512da8; }
.upload-btn-wrapper input[type=file] { font-size:100px; position:absolute; left:0; top:0; opacity:0; cursor:pointer;}
.warn { color:#6a1b9a; font-size:0.85em; margin-left:15px; background:#ede7f6; padding:5px 10px; border-radius:10px;}
</style>
</head>
<body>
<header>Ù…Ø®Ø·Ø· ØªØ·Ø±ÙŠØ² - 2D Ù…Ù†Ø¶Ø¨Ø· ÙˆÙ…Ø­Ø³Ù†</header>

<div id="main"><canvas id="board"></canvas></div>

<div class="controls">
  <button id="clear">Ù…Ø³Ø­</button>
  <button id="export">ØªÙ†Ø²ÙŠÙ„ JSON ÙˆDST</button>
  <div class="upload-btn-wrapper">
    <button class="upload-btn">ğŸ“‚ Ø§Ø®ØªØ± ØµÙˆØ±Ø©</button>
    <input type="file" id="upload" accept="image/*">
  </div>
  <div class="warn">ÙƒÙ„ Ø§Ù„ØºØ±Ø² Ø¨Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø³ÙˆØ¯ ÙˆØ¯Ù‚Ø© Ø§Ù„Ø­ÙˆØ§Ù Ù…Ø­ÙÙˆØ¸Ø©.</div>
</div>

<script>
const board = document.getElementById('board');
const ctx = board.getContext('2d');
let strokes = [];
let imgWidth = 0, imgHeight = 0, dw = 0, dh = 0, offsetX = 0, offsetY = 0;

function resizeCanvas() { board.width = board.clientWidth; board.height = board.clientHeight; }
window.addEventListener('load', resizeCanvas);
window.addEventListener('resize', resizeCanvas);

function traceContours(imgData, width, height) {
  const data = imgData.data;
  const visited = Array(width*height).fill(false);
  const strokes = [];
  function getIndex(x,y){ return y*width+x; }
  function isBlack(x,y){ return data[4*getIndex(x,y)]<50; }
  function followContour(x0,y0){
      const contour=[]; const stack=[[x0,y0]];
      while(stack.length>0){
          const [x,y]=stack.pop();
          if(x<0||y<0||x>=width||y>=height) continue;
          if(visited[getIndex(x,y)]||!isBlack(x,y)) continue;
          visited[getIndex(x,y)] = true;
          contour.push({x,y});
          [[1,0],[0,1],[-1,0],[0,-1],[1,1],[1,-1],[-1,1],[-1,-1]].forEach(([dx,dy])=>stack.push([x+dx,y+dy]));
      }
      function simplify(points,epsilon){ if(points.length<3) return points;
          let dmax=0,index=0,end=points.length-1;
          for(let i=1;i<end;i++){ const dx=points[end].x-points[0].x; const dy=points[end].y-points[0].y;
              const mag=Math.sqrt(dx*dx+dy*dy);
              const distance=Math.abs(dy*points[i].x - dx*points[i].y + points[end].x*points[0].y - points[end].y*points[0].x)/mag;
              if(distance>dmax){ dmax=distance; index=i; }}
          if(dmax>epsilon){ return simplify(points.slice(0,index+1),epsilon).slice(0,-1).concat(simplify(points.slice(index),epsilon)); }
          return [...points];
      }
      return contour.length>4 ? simplify(contour,1) : null;
  }
  for(let y=0;y<height;y++){ for(let x=0;x<width;x++){ if(!visited[getIndex(x,y)] && isBlack(x,y)){ const stroke = followContour(x,y); if(stroke) strokes.push(stroke); }}}
  return strokes;
}

function smoothStroke(points){
  if(points.length<3) return points;
  const smoothed=[points[0]];
  for(let i=1;i<points.length-2;i++){
      const p0=points[i-1],p1=points[i],p2=points[i+1],p3=points[i+2];
      for(let t=0;t<=1;t+=0.15){
          const tt=t*t,ttt=tt*t;
          const x=0.5*((2*p1.x)+(-p0.x+p2.x)*t+(2*p0.x-5*p1.x+4*p2.x-p3.x)*tt+(-p0.x+3*p1.x-3*p2.x+p3.x)*ttt);
          const y=0.5*((2*p1.y)+(-p0.y+p2.y)*t+(2*p0.y-5*p1.y+4*p2.y-p3.y)*tt+(-p0.y+3*p1.y-3*p2.y+p3.y)*ttt);
          smoothed.push({x,y});
      }
  }
  smoothed.push(points[points.length-1]);
  return smoothed;
}

function animateStrokes(strokes, ctx){
  ctx.clearRect(0,0,board.width,board.height);
  ctx.strokeStyle='black'; ctx.lineWidth=1; ctx.lineJoin='round'; ctx.lineCap='round';
  const allPoints=[];
  for(const s of strokes){ const smooth=smoothStroke(s); for(let i=1;i<smooth.length;i++) allPoints.push([smooth[i-1],smooth[i]]); }
  let index=0;
  function drawStep(){ if(index>=allPoints.length) return; const [p1,p2]=allPoints[index]; ctx.beginPath(); ctx.moveTo(p1.x,p1.y); ctx.lineTo(p2.x,p2.y); ctx.stroke(); index++; requestAnimationFrame(drawStep); }
  drawStep();
}

document.getElementById('upload').addEventListener('change',(e)=>{
  const file=e.target.files[0]; if(!file) return;
  const img = new Image(); const reader = new FileReader();
  reader.onload=function(ev){ img.src=ev.target.result; }
  reader.readAsDataURL(file);
  img.onload=function(){
      imgWidth=img.width; imgHeight=img.height;
      const tmpCanvas=document.createElement('canvas'); const tmpCtx=tmpCanvas.getContext('2d');
      tmpCanvas.width=board.width; tmpCanvas.height=board.height;
      const aspect=img.width/img.height; dw=tmpCanvas.width; dh=tmpCanvas.height;
      if(aspect>1){ dh=dw/aspect; } else { dw=dh*aspect; }
      offsetX=(tmpCanvas.width-dw)/2; offsetY=(tmpCanvas.height-dh)/2;
      tmpCtx.fillStyle='white'; tmpCtx.fillRect(0,0,tmpCanvas.width,tmpCanvas.height);
      tmpCtx.drawImage(img,offsetX,offsetY,dw,dh);
      const imgData=tmpCtx.getImageData(0,0,tmpCanvas.width,tmpCanvas.height);
      for(let i=0;i<imgData.data.length;i+=4){ const gray=0.3*imgData.data[i]+0.59*imgData.data[i+1]+0.11*imgData.data[i+2]; const val=gray<128?0:255; imgData.data[i]=imgData.data[i+1]=imgData.data[i+2]=val; }
      strokes=traceContours(imgData,tmpCanvas.width,tmpCanvas.height);
      animateStrokes(strokes,ctx);
  }
});

document.getElementById('clear').onclick=()=>{strokes=[];ctx.clearRect(0,0,board.width,board.height);};

function buildJSONStructured2D(strokes){
  if(strokes.length===0) return { colors:[[0,0,0]], stitches:[] };
  const result={ colors:[[0,0,0]], stitches:[] };
  const scaleX = 4, scaleY = 1;
  strokes.forEach(stroke=>stroke.forEach(pt=>{
      const x = Math.round(((pt.x - offsetX) / dw * imgWidth) * scaleX);
      const y = Math.round(((pt.y - offsetY) / dh * imgHeight) * scaleY);
      result.stitches.push({ color_idx:0, x, y });
  }));
  return result;
}

// Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ø³Ù… Ø«Ø§Ø¨Øª Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ØªØ­Ø°ÙŠØ±
function buildDSTfromStructuredJSON(json){
  if(!json.stitches || json.stitches.length===0) return null;
  const header=new Uint8Array(512); header.fill(0x20);
  const name="DESIGN1"; for(let i=0;i<name.length;i++) header[i]=name.charCodeAt(i);
  const bodyBytes=[]; json.stitches.forEach(s=>{ bodyBytes.push(s.x&0xFF,s.y&0xFF,0x00); });
  const buf=new Uint8Array(512+bodyBytes.length); buf.set(header,0); buf.set(new Uint8Array(bodyBytes),512);
  return buf.buffer;
}

document.getElementById('export').onclick=()=>{
  if(strokes.length===0){ alert('Ø§Ø±ÙØ¹ ØµÙˆØ±Ø© Ø£Ùˆ Ø§Ø±Ø³Ù… Ø´ÙŠØ¦Ù‹Ø§ Ø£ÙˆÙ„Ø§Ù‹'); return; }
  const jsonData=buildJSONStructured2D(strokes);
  const jsonBlob=new Blob([JSON.stringify(jsonData,null,2)],{type:'application/json'});
  const aJSON=document.createElement('a'); aJSON.href=URL.createObjectURL(jsonBlob); aJSON.download='stitches.json'; aJSON.click();

  const dstBuffer=buildDSTfromStructuredJSON(jsonData);
  if(dstBuffer){
      const aDST=document.createElement('a'); aDST.href=URL.createObjectURL(new Blob([dstBuffer],{type:'application/octet-stream'})); aDST.download='design.dst'; aDST.click();
  }
};
</script>
</body>
</html>
